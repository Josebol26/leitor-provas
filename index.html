function processarOMR(qr, ctx) {
    const [alunoPart, tipoPart, gabPart] = qr.data.split('|');
    const nome = alunoPart.split(':')[1];
    const gabarito = gabPart.split(':')[1];

    // --- CONFIGURAÇÃO DE CALIBRAÇÃO ---
    const qrWidth = qr.location.topRightCorner.x - qr.location.topLeftCorner.x;
    const paddingX = qrWidth * 0.55; // Distância horizontal do QR até a 1ª bolinha
    const distInterQuestao = qrWidth * 0.38; // Distância vertical entre questões
    const distInterBolinha = qrWidth * 0.22; // Distância horizontal entre A, B, C...
    // ----------------------------------

    let acertos = 0;
    let html = "";

    // Vamos desenhar no canvas para você ver onde o sensor toca
    ctx.fillStyle = "red";

    gabarito.split('').forEach((correta, i) => {
        let escolhida = "Vazio";
        let maiorEscuridao = 0;

        ['A', 'B', 'C', 'D', 'E'].forEach((letra, index) => {
            // Cálculo do ponto exato
            const posX = qr.location.topRightCorner.x + paddingX + (index * distInterBolinha);
            const posY = qr.location.topRightCorner.y + (i * distInterQuestao) + (qrWidth * 0.1);

            // Desenha o ponto de leitura no canvas (para debug)
            ctx.beginPath();
            ctx.arc(posX, posY, 3, 0, 2 * Math.PI);
            ctx.fill();

            // Análise de Brilho
            const pixelData = ctx.getImageData(posX, posY, 5, 5).data;
            let soma = 0;
            for (let p = 0; p < pixelData.length; p += 4) {
                soma += (pixelData[p] + pixelData[p+1] + pixelData[p+2]) / 3;
            }
            const brilho = soma / (pixelData.length / 4);
            const escuridao = 255 - brilho;

            if (escuridao > maiorEscuridao && escuridao > 60) {
                maiorEscuridao = escuridao;
                escolhida = letra;
            }
        });

        const status = (escolhida === correta);
        if(status) acertos++;

        html += `
            <div class="linha-check">
                <span>Q${i+1}: [${escolhida}]</span>
                <span class="${status ? 'acerto' : 'erro'}">${status ? '✔' : '✘'}</span>
            </div>`;
    });

    // Mostra o canvas de debug por 2 segundos para você ver os pontos vermelhos
    document.getElementById('canvas').style.display = "block";
    document.getElementById('canvas').style.position = "fixed";
    document.getElementById('canvas').style.top = "0";
    document.getElementById('canvas').style.width = "100%";
    
    setTimeout(() => {
        document.getElementById('canvas').style.display = "none";
        exibirPainel(nome, acertos, gabarito.length, html);
    }, 1000);
}

function exibirPainel(nome, acertos, total, html) {
    const nota = ((acertos / total) * 10).toFixed(1);
    document.getElementById('p-nome').innerText = nome;
    document.getElementById('p-resumo').innerText = `Nota: ${nota}`;
    document.getElementById('p-detalhes').innerHTML = html;
    document.getElementById('painel').style.display = 'block';
}
