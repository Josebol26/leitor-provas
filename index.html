<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Scanner de Prova</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<style>
body{
    font-family:Arial;
    text-align:center;
    background:#0f172a;
    color:white;
    margin:0;
}
h2{
    margin-top:15px;
}
video{
    width:95%;
    max-width:500px;
    border-radius:12px;
    margin-top:10px;
}
button{
    padding:12px 20px;
    margin:10px;
    font-size:16px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    background:#22c55e;
    color:white;
}
#resultado{
    background:white;
    color:black;
    padding:20px;
    margin:20px;
    border-radius:12px;
    font-size:18px;
}
.nota{
    font-size:26px;
    font-weight:bold;
    color:#16a34a;
}
</style>
</head>
<body>

<h2>ðŸ“„ Scanner de Prova</h2>

<video id="video" autoplay playsinline></video>
<br>
<button onclick="capturar()">ðŸ“¸ Corrigir Prova</button>

<canvas id="canvas" style="display:none;"></canvas>

<div id="resultado">Aguardando leitura...</div>

<script>

let stream;
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// Gabarito (ajuste se quiser)
const gabarito = ["A","E","C"];

// =========================
// INICIAR CÃ‚MERA TRASEIRA
// =========================
async function iniciarCamera(){
    try{
        stream = await navigator.mediaDevices.getUserMedia({
            video:{
                facingMode:{ ideal:"environment" },
                width:{ideal:1280},
                height:{ideal:720}
            }
        });
        video.srcObject = stream;
    }catch(e){
        alert("Erro ao acessar cÃ¢mera");
    }
}

iniciarCamera();

// =========================
// CAPTURAR
// =========================
function capturar(){

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video,0,0);

    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);

    const qrTexto = lerQR(imageData);
    const resultado = lerOMR(imageData);

    mostrarResultado(qrTexto, resultado);
}

// =========================
// LER QR
// =========================
function lerQR(imageData){

    // Converter para escala de cinza
    let data = imageData.data;

    for(let i = 0; i < data.length; i += 4){
        let media = (data[i] + data[i+1] + data[i+2]) / 3;
        data[i] = data[i+1] = data[i+2] = media > 120 ? 255 : 0;
    }

    const code = jsQR(
        data,
        imageData.width,
        imageData.height
    );

    return code ? code.data : "QR nÃ£o encontrado";
}
// =========================
// LER OMR
// =========================
function lerOMR(imageData){

    let respostasAluno = [];
    let nota = 0;

    const largura = canvas.width;
    const altura = canvas.height;

    const inicioY = altura * 0.55;
    const espacamentoY = altura * 0.08;

    const inicioX = largura * 0.25;
    const espacamentoX = largura * 0.1;

    const alternativas = ["A","B","C","D","E"];

    for(let q=0; q<3; q++){

        let maiorPreenchimento = 0;
        let respostaMarcada = null;

        for(let a=0; a<5; a++){

            let centroX = inicioX + (a * espacamentoX);
            let centroY = inicioY + (q * espacamentoY);

            let soma = contarPixelsEscuros(
                imageData,
                centroX,
                centroY,
                largura
            );

            // exige preenchimento mÃ­nimo
            if(soma > 200 && soma > maiorPreenchimento){
                maiorPreenchimento = soma;
                respostaMarcada = alternativas[a];
            }
        }

        // se nenhuma bolha passou do limite
        if(respostaMarcada === null){
            respostasAluno.push("-");
        }else{
            respostasAluno.push(respostaMarcada);
            if(respostaMarcada === gabarito[q]){
                nota++;
            }
        }
    }

    return {respostasAluno, nota};
}
// =========================
// CONTAR PIXELS ESCUROS
// =========================
function contarPixelsEscuros(imageData, cx, cy, largura){

    let raio = 14;
    let soma = 0;

    for(let y=-raio; y<raio; y++){
        for(let x=-raio; x<raio; x++){

            if(x*x + y*y <= raio*raio){

                let px = Math.floor(cx + x);
                let py = Math.floor(cy + y);

                if(px<0 || py<0) continue;

                let pos = (py * largura + px) * 4;

                let r = imageData.data[pos];
                let g = imageData.data[pos+1];
                let b = imageData.data[pos+2];

                let brilho = (r+g+b)/3;

                if(brilho < 130){
                    soma++;
                }
            }
        }
    }

    return soma;
}

// =========================
// MOSTRAR RESULTADO
// =========================
function mostrarResultado(qr, resultado){

    document.getElementById("resultado").innerHTML = `
        <p><b>QR:</b> ${qr}</p>
        <p><b>Respostas:</b> ${resultado.respostasAluno.join(", ")}</p>
        <p class="nota">Nota: ${resultado.nota}</p>
    `;
}

</script>
</body>
</html>
