<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Scanner OMR</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<style>
body{
    font-family:Arial;
    text-align:center;
    background:#f0f0f0;
}
video, canvas{
    width:90%;
    max-width:500px;
    border:2px solid #000;
    margin:10px;
}
button{
    padding:10px 20px;
    font-size:16px;
    cursor:pointer;
}
#resultado{
    background:white;
    padding:15px;
    margin-top:15px;
    border-radius:8px;
}
</style>
</head>
<body>

<h2>ðŸ“„ Scanner OMR</h2>

<video id="video" autoplay></video>
<br>
<button onclick="capturar()">ðŸ“¸ Capturar</button>

<canvas id="canvas" style="display:none;"></canvas>

<div id="resultado"></div>

<script>

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// Ativar cÃ¢mera
navigator.mediaDevices.getUserMedia({video:true})
.then(stream => video.srcObject = stream);

// Gabarito (altere se quiser)
const gabarito = ["A","E","C"];

function capturar(){

    document.getElementById("resultado").innerHTML = "";

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0);

    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);

    lerQR(imageData);
    lerOMR(imageData);
}

// =====================
// LEITURA QR CODE
// =====================
function lerQR(imageData){

    const code = jsQR(imageData.data,
                      imageData.width,
                      imageData.height);

    if(code){
        document.getElementById("resultado").innerHTML +=
            "<p><b>QR:</b> "+code.data+"</p>";
    }else{
        document.getElementById("resultado").innerHTML +=
            "<p>QR nÃ£o encontrado</p>";
    }
}

// =====================
// LEITURA OMR
// =====================
function lerOMR(imageData){

    let respostasAluno = [];
    let nota = 0;

    const largura = canvas.width;
    const altura = canvas.height;

    const inicioY = altura * 0.55;
    const espacamentoY = altura * 0.08;

    const inicioX = largura * 0.25;
    const espacamentoX = largura * 0.1;

    const alternativas = ["A","B","C","D","E"];

    for(let q=0; q<3; q++){

        let maiorPreenchimento = 0;
        let respostaMarcada = null;

        for(let a=0; a<5; a++){

            let centroX = inicioX + (a * espacamentoX);
            let centroY = inicioY + (q * espacamentoY);

            let soma = contarPixelsEscuros(
                imageData,
                centroX,
                centroY,
                largura
            );

            if(soma > maiorPreenchimento){
                maiorPreenchimento = soma;
                respostaMarcada = alternativas[a];
            }
        }

        respostasAluno.push(respostaMarcada);

        if(respostaMarcada === gabarito[q]){
            nota++;
        }
    }

    document.getElementById("resultado").innerHTML +=
        "<p><b>Respostas:</b> "+respostasAluno.join(", ")+"</p>";

    document.getElementById("resultado").innerHTML +=
        "<p><b>Nota:</b> "+nota+"</p>";
}

// =====================
// Conta pixels escuros numa Ã¡rea circular
// =====================
function contarPixelsEscuros(imageData, cx, cy, largura){

    let raio = 12;
    let soma = 0;

    for(let y=-raio; y<raio; y++){
        for(let x=-raio; x<raio; x++){

            if(x*x + y*y <= raio*raio){

                let px = Math.floor(cx + x);
                let py = Math.floor(cy + y);

                let pos = (py * largura + px) * 4;

                let r = imageData.data[pos];
                let g = imageData.data[pos+1];
                let b = imageData.data[pos+2];

                let brilho = (r+g+b)/3;

                if(brilho < 120){
                    soma++;
                }
            }
        }
    }

    return soma;
}

</script>
</body>
</html>
