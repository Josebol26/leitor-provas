<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Scanner de Prova</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<style>
body{
    font-family:Arial;
    text-align:center;
    background:#0f172a;
    color:white;
    margin:0;
}
h2{ margin-top:15px; }
video{
    width:95%;
    max-width:500px;
    border-radius:12px;
    margin-top:10px;
}
button{
    padding:12px 20px;
    margin:10px;
    font-size:16px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    background:#22c55e;
    color:white;
}
#resultado{
    background:white;
    color:black;
    padding:20px;
    margin:20px;
    border-radius:12px;
    font-size:18px;
}
.nota{
    font-size:26px;
    font-weight:bold;
    color:#16a34a;
}
</style>
</head>
<body>

<h2>ðŸ“„ Scanner de Prova</h2>

<video id="video" autoplay playsinline></video>
<br>
<button onclick="capturar()">ðŸ“¸ Corrigir Prova</button>

<canvas id="canvas" style="display:none;"></canvas>

<div id="resultado">Aguardando leitura...</div>

<script>

let stream;
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// AJUSTE SEU GABARITO AQUI
const gabarito = ["A","E","C"];

// =========================
// INICIAR CÃ‚MERA TRASEIRA
// =========================
async function iniciarCamera(){
    try{
        stream = await navigator.mediaDevices.getUserMedia({
            video:{
                facingMode:{ ideal:"environment" },
                width:{ideal:1280},
                height:{ideal:720}
            }
        });
        video.srcObject = stream;
    }catch(e){
        alert("Erro ao acessar cÃ¢mera");
    }
}
iniciarCamera();

// =========================
// CAPTURAR
// =========================
function capturar(){

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video,0,0);

    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);

    const qr = lerQR(imageData);

    if(!qr){
        mostrarResultado("QR nÃ£o encontrado", {respostasAluno:["-","-","-"], nota:0});
        return;
    }

    const resultado = lerOMR(imageData, qr.location);

    mostrarResultado(qr.texto, resultado);
}

// =========================
// LER QR
// =========================
function lerQR(imageData){

    const code = jsQR(
        imageData.data,
        imageData.width,
        imageData.height
    );

    if(!code) return null;

    return {
        texto: code.data,
        location: code.location
    };
}

// =========================
// LER OMR BASEADO NO QR
// =========================
function lerOMR(imageData, qrLocation){

    let respostasAluno = [];
    let nota = 0;

    const largura = canvas.width;

    // Base na parte inferior do QR
    const baseY = qrLocation.bottomRightCorner.y;

    // AJUSTES FINOS (podemos calibrar se precisar)
    const espacamentoY = 65;
    const espacamentoX = 55;
    const inicioX = qrLocation.bottomRightCorner.x - 220;
    const inicioY = baseY + 130;

    const alternativas = ["A","B","C","D","E"];

    for(let q=0; q<3; q++){

        let maiorPreenchimento = 0;
        let respostaMarcada = null;

        for(let a=0; a<5; a++){

            let centroX = inicioX + (a * espacamentoX);
            let centroY = inicioY + (q * espacamentoY);

            let soma = contarPixelsEscuros(
                imageData,
                centroX,
                centroY,
                largura
            );

            if(soma > 180 && soma > maiorPreenchimento){
                maiorPreenchimento = soma;
                respostaMarcada = alternativas[a];
            }
        }

        if(respostaMarcada === null){
            respostasAluno.push("-");
        }else{
            respostasAluno.push(respostaMarcada);
            if(respostaMarcada === gabarito[q]){
                nota++;
            }
        }
    }

    return {respostasAluno, nota};
}

// =========================
// CONTAR PIXELS ESCUROS
// =========================
function contarPixelsEscuros(imageData, cx, cy, largura){

    let raio = 14;
    let soma = 0;

    for(let y=-raio; y<raio; y++){
        for(let x=-raio; x<raio; x++){

            if(x*x + y*y <= raio*raio){

                let px = Math.floor(cx + x);
                let py = Math.floor(cy + y);

                if(px<0 || py<0) continue;

                let pos = (py * largura + px) * 4;

                let r = imageData.data[pos];
                let g = imageData.data[pos+1];
                let b = imageData.data[pos+2];

                let brilho = (r+g+b)/3;

                if(brilho < 130){
                    soma++;
                }
            }
        }
    }

    return soma;
}

// =========================
// MOSTRAR RESULTADO
// =========================
function mostrarResultado(qr, resultado){

    document.getElementById("resultado").innerHTML = `
        <p><b>QR:</b> ${qr}</p>
        <p><b>Respostas:</b> ${resultado.respostasAluno.join(", ")}</p>
        <p class="nota">Nota: ${resultado.nota}</p>
    `;
}

</script>
</body>
</html>
